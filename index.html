<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>グラム単価比較</title>
    <!-- Base tag to fix relative path issues in subdirectories -->
    <base href="./">
    <link rel="manifest" href="manifest.json" />
    
    <!-- PWA meta tags for iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="単価比較">
    <link rel="apple-touch-icon" href="assets/icon.svg">

    <!-- Theme Color for browsers -->
    <meta name="theme-color" content="#111827" />

    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#10b981', // emerald-500
              'primary-focus': '#059669', // emerald-600
              'secondary': '#374151', // gray-700
              'background': '#111827', // gray-900
              'surface': '#1f2937', // gray-800
              'on-surface': '#f9fafb', // gray-50
              'best-deal': '#fde047', // yellow-300
            },
          },
        },
      }
    </script>

    <!-- React and ReactDOM from CDN -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel Standalone to transpile JSX in the browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
      /* Style to prevent flash of unstyled content (FOUC) */
      body { background-color: #111827; }
      /* Add padding for device notches */
      body {
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
        padding-right: env(safe-area-inset-right);
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-background text-on-surface">
    <div id="root"></div>

    <!-- All React components and logic are inlined here -->
    <script type="text/babel" data-presets="react,typescript">
      const { useState, useCallback, FC } = React;

      // --- All components and types go here ---

      // from components/icons.tsx
      const PlusIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
        </svg>
      );
      const TrashIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
          <path strokeLinecap="round" strokeLinejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
        </svg>
      );
      const RefreshIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M4 4v5h5m11 2a8.963 8.963 0 01-1.586 5.04M20 20v-5h-5m-1.414-1.414A9 9 0 014 12" />
        </svg>
      );
      const CrownIcon = ({ className }) => (
        <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2L9.16 8.44L2 9.27L7.33 14.39L5.92 21.24L12 17.61L18.08 21.24L16.67 14.39L22 9.27L14.84 8.44L12 2Z" />
        </svg>
      );

      // from components/ItemCard.tsx
      const ItemCard = ({ item, itemNumber, isBestDeal, onUpdate, onRemove }) => {
        const handleInputChange = (field) => (e) => {
          onUpdate(item.id, field, e.target.value);
        };

        const formattedUnitPrice = item.unitPrice !== null
          ? `¥ ${item.unitPrice.toFixed(2)} /g`
          : '---';

        const cardBorderClass = isBestDeal
          ? 'border-best-deal ring-2 ring-best-deal/50'
          : 'border-secondary';

        return (
          <div className={`relative bg-surface rounded-xl shadow-lg border transition-all duration-300 ${cardBorderClass}`}>
            {isBestDeal && (
              <div className="absolute -top-3 -left-3 bg-best-deal text-background p-2 rounded-full shadow-lg transform rotate-[-15deg]">
                <CrownIcon className="w-6 h-6" />
              </div>
            )}
            <div className="p-5">
              <div className="flex justify-between items-center mb-4">
                 <input
                    type="text"
                    value={item.name}
                    onChange={handleInputChange('name')}
                    placeholder={`商品 ${itemNumber}`}
                    aria-label={`商品 ${itemNumber} の品名`}
                    className="flex-grow bg-transparent text-lg font-bold text-on-surface focus:outline-none focus:ring-0 border-b-2 border-transparent focus:border-primary transition-colors duration-200 mr-2"
                  />
                <button
                  onClick={() => onRemove(item.id)}
                  className="p-2 rounded-full text-gray-400 hover:bg-red-500/20 hover:text-red-400 transition-colors duration-200"
                  aria-label="商品を削除"
                >
                  <TrashIcon className="w-5 h-5" />
                </button>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label htmlFor={`price-${item.id}`} className="block text-sm font-medium text-gray-300 mb-1">
                    価格 (円)
                  </label>
                  <input
                    id={`price-${item.id}`}
                    type="number"
                    value={item.price}
                    onChange={handleInputChange('price')}
                    placeholder="例: 1000"
                    className="w-full bg-secondary border border-gray-600 rounded-md px-3 py-2 text-on-surface focus:ring-2 focus:ring-primary focus:border-primary transition"
                    inputMode="decimal"
                  />
                </div>
                <div>
                  <label htmlFor={`weight-${item.id}`} className="block text-sm font-medium text-gray-300 mb-1">
                    内容量 (g)
                  </label>
                  <input
                    id={`weight-${item.id}`}
                    type="number"
                    value={item.weight}
                    onChange={handleInputChange('weight')}
                    placeholder="例: 250"
                    className="w-full bg-secondary border border-gray-600 rounded-md px-3 py-2 text-on-surface focus:ring-2 focus:ring-primary focus:border-primary transition"
                    inputMode="decimal"
                  />
                </div>
              </div>
            </div>
            <div className="bg-secondary/50 rounded-b-xl px-5 py-4 mt-4">
              <p className="text-sm text-gray-400">グラム単価</p>
              <p className={`text-2xl font-bold transition-colors duration-300 ${isBestDeal ? 'text-best-deal' : 'text-on-surface'}`}>
                {formattedUnitPrice}
              </p>
            </div>
          </div>
        );
      };

      // from App.tsx
      const App = () => {
        const createNewItem = () => ({
          id: crypto.randomUUID(),
          name: '',
          price: '',
          weight: '',
          unitPrice: null,
        });

        const [items, setItems] = useState([createNewItem()]);
        const [bestDealId, setBestDealId] = useState(null);

        const recalculateAndSetState = useCallback((currentItems) => {
          let minUnitPrice = Infinity;
          let newBestDealId = null;

          const calculatedItems = currentItems.map(item => {
            const price = parseFloat(String(item.price));
            const weight = parseFloat(String(item.weight));

            if (!isNaN(price) && price > 0 && !isNaN(weight) && weight > 0) {
              const unitPrice = price / weight;
              if (unitPrice < minUnitPrice) {
                minUnitPrice = unitPrice;
              }
              return { ...item, unitPrice };
            }
            return { ...item, unitPrice: null };
          });

          if (minUnitPrice !== Infinity) {
            const bestItem = calculatedItems.find(item => item.unitPrice === minUnitPrice);
            if (bestItem) {
              newBestDealId = bestItem.id;
            }
          }
          
          setItems(calculatedItems);
          setBestDealId(newBestDealId);
        }, []);

        const handleUpdateItem = useCallback((id, field, value) => {
          const newItems = items.map(item =>
            item.id === id ? { ...item, [field]: value } : item
          );
          recalculateAndSetState(newItems);
        }, [items, recalculateAndSetState]);

        const handleAddItem = useCallback(() => {
          const newItems = [...items, createNewItem()];
          recalculateAndSetState(newItems);
        }, [items, recalculateAndSetState]);

        const handleRemoveItem = useCallback((id) => {
          if (items.length > 1) {
            const newItems = items.filter(item => item.id !== id);
            recalculateAndSetState(newItems);
          } else {
            handleReset();
          }
        }, [items, recalculateAndSetState]);

        const handleReset = useCallback(() => {
          const newItems = [createNewItem()];
          recalculateAndSetState(newItems);
        }, [recalculateAndSetState]);
        
        return (
          <div className="min-h-screen bg-background font-sans">
            <header className="bg-surface shadow-lg sticky top-0 z-10">
              <div className="container mx-auto px-4 py-4 flex justify-between items-center">
                <h1 className="text-xl md:text-2xl font-bold text-on-surface tracking-tight">
                  グラム単価 比較ツール
                </h1>
                <button
                  onClick={handleReset}
                  className="p-2 rounded-full text-gray-400 hover:bg-secondary hover:text-white transition-colors duration-200"
                  aria-label="リセット"
                >
                  <RefreshIcon className="w-6 h-6" />
                </button>
              </div>
            </header>

            <main className="container mx-auto p-4">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-24">
                {items.map((item, index) => (
                  <ItemCard
                    key={item.id}
                    item={item}
                    itemNumber={index + 1}
                    isBestDeal={item.id === bestDealId && item.unitPrice !== null}
                    onUpdate={handleUpdateItem}
                    onRemove={handleRemoveItem}
                  />
                ))}
              </div>

              <div className="fixed bottom-0 left-0 right-0 p-4 bg-background/70 backdrop-blur-sm flex justify-center z-10" style={{ paddingBottom: 'calc(1rem + env(safe-area-inset-bottom))' }}>
                <button
                  onClick={handleAddItem}
                  className="flex items-center gap-2 bg-primary hover:bg-primary-focus text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out"
                >
                  <PlusIcon className="w-6 h-6" />
                  <span>商品を追加</span>
                </button>
              </div>
            </main>
          </div>
        );
      };

      // from index.tsx
      const rootElement = document.getElementById('root');
      const root = ReactDOM.createRoot(rootElement);
      root.render(<App />);

    </script>
    
    <script>
      // Service Worker registration
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('sw.js').then(registration => {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, err => {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
  <script type="module" src="/index.tsx"></script>
</body>
</html>
